<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somnia - Einschlafhilfe</title>
    
    <!-- Tailwind CSS CDN für Utility Classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons für Symbole (Einstellungen, Zurück etc.) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- INTEGRIERTER STIL (VORHER: style.css) -->
    <style>
        /* Konfigurieren der Hauptfarben basierend auf den Wireframes */
        :root {
            --color-dark-blue: #2B4162; 
            --color-light-bg: #F5F5E0; 
            --color-accent: #E95E95; 
            --color-button-soft: #BEE3DB; 
        
            /* Neue Farben für die Genre-Auswahl */
            --color-genre-1: #C9D9E9;
            --color-genre-2: #B0C4DE;
            --color-genre-3: #FFFFFF;
            --color-genre-4: #B3D9D9;
            --color-header-icon: #333333;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-light-bg);
            overflow-x: hidden;
        }
        
        .app-container {
            width: 100%;
            max-width: 480px; 
            height: 100vh;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
            overflow: hidden; 
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hidden-screen {
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        .visible-screen {
            opacity: 1;
            pointer-events: auto;
            z-index: 10;
        }
        
        .app-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem; 
            position: relative; 
            color: var(--color-header-icon);
        }
        
        .header-title {
            position: absolute;
            left: 50%;
            top: 50%; 
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-dark-blue);
            z-index: 5;
        }
        
        .header-icon-wrapper {
            z-index: 10;
            padding: 0;
        }
        
        /* Screens Styling */
        #splash-screen {
            background-image: url('./Somnia-Bilder/schlafendeperson.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--color-light-bg);
            text-align: center;
            text-shadow: 0px 2px 8px rgba(0,0,0,0.4); 
            justify-content: space-between;
            padding: 15vh 24px;
        }
        
        #splash-screen h1, .splash-bottom-content {
            z-index: 20; 
            position: relative; 
        }
        
        #main-menu-screen {
            background-image: url('./Somnia-Bilder/zweiterscreen.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            justify-content: space-between;
            padding: 24px;
            color: var(--color-dark-blue); 
            text-shadow: 0px 0px 4px rgba(255,255,255,0.7); 
        }
        
        #main-menu-screen .flex, #main-menu-screen h2, #main-menu-screen button {
            z-index: 20;
            position: relative;
        }
        
        #settings-menu-screen, 
        #genre-selection-screen,
        #sleeptimer-selection-screen,
        #playback-screen { 
            background-image: url('./Somnia-Bilder/genrescreen.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 24px;
            justify-content: flex-start;
        }
        
        /* ********************************************* */
        /* ATEMÜBUNG ANIMATION & PLACEHOLDER             */
        /* ********************************************* */
        
        .atemuebung {
            background-image: url('./Somnia-Bilder/atmen.png');
            /* background-image: url('./Somnia-Bilder/atem_background.jpg'); */
            background-color: #a0d3f5; /* Hellblaues Fallback */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* Animation: Atmen */
        @keyframes breathe {
            0% {
                transform: scale(1); /* Klein */
            }
            50% {
                transform: scale(1.4); /* Groß (Einatmen) */
            }
            100% {
                transform: scale(1); /* Klein (Ausatmen) */
            }
        }
        
        .breathing-circle {
            /* 8 Sekunden pro Zyklus (4 ein, 4 aus) */
            animation: breathe 8s ease-in-out infinite;
            /* Glatter Schatten */
            box-shadow: 0 0 20px rgba(66, 153, 225, 0.5);
        }
        
        /* --------------------------------------------- */
        
        
        .settings-menu-item {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-top: 1rem;
            border-bottom: 1px solid #E0E0E0;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--color-dark-blue);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        
        .settings-menu-item:hover {
            background-color: #FAFAFA;
        }
        
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 320px;
            margin-top: 2rem;
        }
        
        .genre-button {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-dark-blue);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            border: 3px solid transparent;
        }
        
        .genre-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .genre-button.active {
            border-color: var(--color-accent);
            box-shadow: 0 0 10px rgba(233, 94, 149, 0.5);
        }
        
        .timer-button {
            width: 100%;
            padding: 1rem;
            background-color: white;
            border: 1px solid #E0E0E0;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.125rem;
            color: var(--color-dark-blue);
            font-weight: 500;
            transition: background-color 0.1s, font-weight 0.1s;
        }
        
        .timer-button:hover {
            background-color: #F8F8F8;
        }
        
        .timer-button.active {
            font-weight: 800;
            background-color: var(--color-button-soft);
            border-color: var(--color-button-soft);
        }
        #voice-selection-screen {
            background-image: url('./Somnia-Bilder/genrescreen.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 24px;
            justify-content: flex-start;
        }
        /* --------------------------------------------- */
        /* Neuer großer Button im Atemübungs-Screen      */
        /* --------------------------------------------- */
        
        .breathing-skip-button {
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        
            background-color: var(--color-button-soft);
            color: var(--color-dark-blue);
        
            border: 2px solid var(--color-dark-blue);
            border-radius: 1rem;
        
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        
            transition: all 0.2s ease-in-out;
        }
        
        .breathing-skip-button:hover {
            background-color: #d9f4ee; /* etwas heller */
            transform: scale(1.03);
            box-shadow: 0 6px 14px rgba(0,0,0,0.2);
        }
        
        .breathing-skip-button:active {
            transform: scale(0.97);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        #profile-modal {
            display: none;
        }
        
        #profile-modal.flex {
            display: flex;
        }
        
        /* ----- Individueller Hintergrund für den PLAYBACK-SCREEN ----- */
        #playback-screen {
            background-image: url('./Somnia-Bilder/playscreen.png'); /* <– Dein Bild hier */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body>

    <div class="app-container">

        <!-- 1. SPLASH SCREEN (Startbildschirm) -->
        <div id="splash-screen" class="screen visible-screen">
            <h1 class="text-6xl font-extrabold tracking-widest uppercase" style="color: white;">
                SOMNIVA
            </h1>
            <div class="splash-bottom-content text-center">
                <p class="text-lg font-light mb-4" style="color: white;">
                    hilft dir, deine Gedanken abzuschalten und
                    <span class="font-bold">sanft einzuschlafen</span>.
                </p>
                <button onclick="transitionToMainMenu()" class="mt-8 text-sm font-semibold uppercase tracking-wider py-3 px-6 rounded-full bg-white text-gray-800 shadow-xl hover:bg-gray-100 transition-colors">
                    Los geht's
                </button>
            </div>
        </div>

        <!-- 2. MAIN MENU SCREEN (Hauptmenü) -->
        <div id="main-menu-screen" class="screen hidden-screen">
            <div class="app-header">
                <div class="header-icon-wrapper">
                    <button onclick="transitionToScreen('settings-menu-screen')" aria-label="Einstellungen öffnen" 
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="settings" class="w-10 h-10"></i>
                    </button>
                </div>
                <div class="header-icon-wrapper">
                    <button onclick="showProfile()" aria-label="Profil öffnen"
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="user" class="w-10 h-10"></i>
                    </button>
                </div>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center p-8">
                <h2 class="text-3xl font-bold mb-10 text-gray-800"></h2>
                <div class="text-5xl mb-6 text-gray-700"></div> 
            </div>
            <div class="w-full p-6">
                <button onclick="transitionToScreen('sleeptimer-selection-screen')" 
                        class="w-full py-4 rounded-xl text-lg font-semibold uppercase tracking-wider shadow-lg transition-all 
                                bg-white text-gray-800 border-2 border-gray-200 
                                hover:shadow-xl hover:bg-gray-50"
                        style="background-color: var(--color-button-soft);">
                    EINSCHLAFROUTINE STARTEN
                </button>
            </div>
        </div>

        <!-- 3. SETTINGS MENU SCREEN -->
        <div id="settings-menu-screen" class="screen hidden-screen">
            <div class="app-header">
                <div class="header-icon-wrapper">
                    <button onclick="goBack()" aria-label="Zurück zum Hauptmenü" 
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                </div>
                <h2 class="header-title">Einstellungen</h2>
                <div class="header-icon-wrapper"></div> 
            </div>
            <div class="w-full max-w-md mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Grundlegende Voreinstellungen</h3>
                <div onclick="transitionToScreen('genre-selection-screen')" class="settings-menu-item">
                    <span>Genre</span>
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </div>
                <div onclick="transitionToScreen('voice-selection-screen')" class="settings-menu-item">
                    <span>Stimme</span>
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </div>
            </div>
        </div>
        
        <!-- 3.5 VOICE SELECTION SCREEN -->
        <div id="voice-selection-screen" class="screen hidden-screen">
            <div class="app-header">
                <div class="header-icon-wrapper">
                    <button onclick="goBack()" aria-label="Zurück"
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                </div>
                <h2 class="header-title">Stimme</h2>
                <div class="header-icon-wrapper"></div> 
            </div>
        
            <div class="w-full max-w-md mt-10 px-6 space-y-8">
        
                <!-- Stimme auswählen -->
                <div>
                    <label class="text-lg font-semibold text-gray-800">Stimme</label>
                    <select id="voice-select" onchange="updateVoiceSetting()"
                            class="w-full mt-2 p-3 rounded-lg border border-gray-300 bg-white shadow-md">
                        <option value="Kore">Kore (weiblich, Firm)</option>
                        <option value="Puck">Puck (männlich, Upbeat)</option>
                        <option value="Charon">Charon (weiblich, Informative)</option>
                        <!-- Hier weitere Stimmen einfügen, falls gewünscht -->
                    </select>
                </div>
        
                <!-- Geschwindigkeit (Hier nicht direkt relevant für die API, aber im UI lassen) -->
                <div>
                    <label class="text-lg font-semibold text-gray-800">Geschwindigkeit</label>
                    <input id="speed-slider" type="range" min="0.5" max="1.5" value="1" step="0.05"
                            class="w-full mt-3">
                </div>
        
                <button onclick="transitionToScreen('sleeptimer-selection-screen')"
                        class="w-full py-4 rounded-xl text-lg font-semibold uppercase tracking-wider shadow-lg bg-gray-800 text-white">
                    los geht’s !
                </button>
            </div>
        </div>

        <!-- 4. GENRE SELECTION SCREEN -->
        <div id="genre-selection-screen" class="screen hidden-screen">
            <div class="app-header">
                <div class="header-icon-wrapper">
                    <button onclick="goBack()" aria-label="Zurück zu den Einstellungen" 
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                </div>
                <h2 class="header-title">Genre</h2>
                <div class="header-icon-wrapper"></div> 
            </div>
            <div class="genre-grid">
                <!-- Beachte: Das 'active' Attribut wird im JS gesetzt/entfernt, aber 'Hörbuch' ist der Standard in der JS-Logik -->
                <button onclick="selectGenre('Märchen')" class="genre-button" style="background-color: var(--color-genre-1);">Märchen</button>
                <button onclick="selectGenre('Hörbuch')" class="genre-button" style="background-color: var(--color-genre-2);">Hörbuch</button>
                <button onclick="selectGenre('White Noise')" class="genre-button" style="background-color: var(--color-genre-3);">White Noise</button>
                <button onclick="selectGenre('Naturgeräusche')" class="genre-button" style="background-color: var(--color-genre-4);">Naturgeräusche</button>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4 max-w-xs"></p>
        </div>
        
        <!-- 5. SLEEPTIMER SELECTION SCREEN -->
        <div id="sleeptimer-selection-screen" class="screen hidden-screen">
            <div class="app-header">
                <div class="header-icon-wrapper">
                    <button onclick="goBack()" aria-label="Zurück zum Hauptmenü" 
                            class="text-gray-800 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-200">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                </div>
                <h2 class="header-title">SLEEPTIMER</h2>
                <div class="header-icon-wrapper"></div> 
            </div>
            <div class="w-full max-w-sm p-4 mt-8 space-y-4">
                <button onclick="setTimerActive(this, '5')" class="timer-button" data-minutes="5">5 Minuten</button>
                <button onclick="setTimerActive(this, '10')" class="timer-button" data-minutes="10">10 Minuten</button>
                <button onclick="setTimerActive(this, '15')" class="timer-button active" data-minutes="15">15 Minuten</button>
                <button onclick="setTimerActive(this, '30')" class="timer-button" data-minutes="30">30 Minuten</button>
                <button onclick="setTimerActive(this, '45')" class="timer-button" data-minutes="45">45 Minuten</button>
                <button onclick="setTimerActive(this, '60')" class="timer-button" data-minutes="60">1 Stunde</button>
                <button onclick="setTimerActive(this, '0')" class="timer-button" data-minutes="0">nach Ende der Geschichte</button>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4 max-w-xs"></p>
            
            <div class="w-full p-6 mt-auto">
                <button onclick="startBreathingExercise()" 
                        class="w-full py-4 rounded-xl text-lg font-semibold uppercase tracking-wider shadow-lg transition-all 
                                bg-gray-800 text-white border-2 border-gray-700 
                                hover:shadow-xl hover:bg-gray-700"
                        style="background-color: var(--color-accent); color: white;">
                    ZUFÄLLIGE ROUTINE STARTEN
                </button>
            </div>
        </div>

        <!-- 5.5 ATEMÜBUNG SCREEN -->
        <div id="breathing-screen" class="screen hidden-screen atemuebung flex flex-col items-center justify-center text-center">
            
            <div class="absolute top-12">
                <h2 class="text-2xl font-bold text-gray-700 tracking-widest uppercase">Meditative Atmung</h2>
            </div>

            <!-- Atem-Animation -->
            <div class="relative flex items-center justify-center mt-10">
                <!-- Äußerer Ripple-Kreis -->
                <div class="absolute w-72 h-72 rounded-full bg-blue-300 opacity-30 animate-pulse"></div>
                
                <!-- Der atmende Kreis -->
                <div class="w-48 h-48 rounded-full bg-white bg-opacity-90 flex items-center justify-center shadow-2xl breathing-circle">
                    <span id="breathing-text" class="text-blue-900 font-bold text-xl tracking-wider">Einatmen</span>
                </div>
            </div>

            <!-- Fixierter Button am unteren Rand -->
            <div class="absolute bottom-12 px-8 w-full">
               <button onclick="skipBreathing()" class="breathing-skip-button">
                    ÜBERSPRINGEN & GESCHICHTE STARTEN
                </button>
            </div>
        </div>
        
        
        <!-- 6. PLAYBACK SCREEN -->
        <div id="playback-screen" class="screen hidden-screen">
            <div class="app-header justify-center">
                <div class="text-gray-800 p-2 rounded-full">
                    <i data-lucide="moon" class="w-6 h-6"></i>
                </div>
                <h2 id="playback-title" class="header-title font-light"></h2>
                <div class="header-icon-wrapper"></div> 
            </div>
            
            <!-- Inhalt des Playback Screens -->
            <div class="flex flex-col items-center justify-start flex-grow p-8 w-full pt-[20vh]">
                <h3 id="current-content-title" class="text-2xl font-bold text-gray-800 mb-2 text-center">Titel der Geschichte</h3>
                <p id="current-content-genre" class="text-lg text-gray-500 mb-8">Genre</p>
                <div class="flex items-center space-x-2 text-3xl font-mono mb-8 p-3 rounded-xl bg-gray-100 shadow-inner">
                    <i data-lucide="clock" class="w-6 h-6 text-gray-500"></i>
                    <span id="countdown-timer" class="text-gray-700 font-extrabold">--:--</span>
                </div>
                <p id="loading-status" class="text-sm text-gray-600 font-semibold italic mb-8"></p>

                <div class="flex flex-col items-center w-full mt-auto pb-8">
                    <div class="flex items-center justify-center space-x-6">
                        <button id="play-button" onclick="togglePlayback(true)" class="bg-gray-800 text-white p-6 rounded-full shadow-xl hover:bg-gray-700 transition-transform transform hover:scale-105 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                        <button id="pause-button" onclick="togglePlayback(false)" class="hidden bg-gray-800 text-white p-6 rounded-full shadow-xl hover:bg-gray-700 transition-transform transform hover:scale-105 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                        </button>
                        <button id="stop-button" onclick="stopPlayback()" class="bg-red-100 text-red-600 p-4 rounded-full hover:bg-red-200 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-6 uppercase tracking-widest"></p>
                </div>
            </div>
        </div>
        
        <!-- Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full text-center">
                <p id="modal-text" class="text-gray-800 mb-4 font-medium"></p>
                <button onclick="hideMessage()" class="bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">OK</button>
            </div>
        </div>
        
        <!-- PROFIL-MODAL -->
        <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full text-center">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Dein Profil</h2>

                <p class="text-gray-700 mb-2"><strong>Gestartete Routinen:</strong> <span id="profile-routines">0</span></p>
                <p class="text-gray-700 mb-2"><strong>Gesamte Hörzeit:</strong> <span id="profile-time">0</span> min</p>
                <p class="text-gray-700 mb-4"><strong>Letztes Genre:</strong> <span id="profile-last-genre">–</span></p>

                <button onclick="hideProfile()" class="bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                    Schließen
                </button>
            </div>
        </div>

        
        <!-- Lade-Indikator -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[100]">
            <div class="flex flex-col items-center p-8 rounded-xl bg-white shadow-2xl">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-800 font-semibold">Lade Audio... Bitte warten.</p>
            </div>
        </div>

    </div>

    <!-- INTEGRIERTES JAVASCRIPT (VORHER: script.js) -->
    <script>
        let currentScreen = 'splash-screen';
        const screenHistory = [];
        let selectedGenre = 'Hörbuch'; // Default
        let selectedTimerMinutes = 15; // Default
        let selectedVoice = 'Kore'; // Default
        let isPlaying = false;

        // Placeholder data for profile
        let routineCount = 0;
        let totalTime = 0;
        let lastGenre = '-';
        
        // --- Hilfsfunktionen für Modals ---

        function showMessage(text) {
            document.getElementById('modal-text').textContent = text;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        function hideMessage() {
            document.getElementById('message-modal').classList.remove('flex');
            document.getElementById('message-modal').classList.add('hidden');
        }
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('flex');
            document.getElementById('loading-overlay').classList.add('hidden');
        }


        // --- Navigationsfunktionen ---
        
        function transitionToScreen(nextScreenId) {
            const currentElement = document.getElementById(currentScreen);
            const nextElement = document.getElementById(nextScreenId);
        
            if (currentElement && nextElement) {
                // Nur speichern, wenn der aktuelle Screen nicht der Startbildschirm ist
                if (currentScreen !== 'splash-screen' && currentScreen !== 'breathing-screen') {
                    screenHistory.push(currentScreen);
                } else if (currentScreen === 'breathing-screen' && nextScreenId !== 'playback-screen') {
                    // Wenn wir von der Atemübung zurückgehen, ist der Zielscreen der Sleeptimer-Screen
                    // Hier nur das Zurücksetzen der Animation und Navigation
                }
                
                currentElement.classList.remove('visible-screen');
                currentElement.classList.add('hidden-screen');
                
                nextElement.classList.remove('hidden-screen');
                nextElement.classList.add('visible-screen');
                
                currentScreen = nextScreenId;
        
                // Atem-Animation stoppen, wenn wir den Screen verlassen
                if (currentScreen !== 'breathing-screen') {
                    stopBreathingAnimation();
                }

                // Lucide Icons neu rendern
                lucide.createIcons();
            }
        }
        
        function goBack() {
            if (screenHistory.length > 0) {
                const previousScreenId = screenHistory.pop();
                
                const currentElement = document.getElementById(currentScreen);
                const previousElement = document.getElementById(previousScreenId);
        
                if (currentElement && previousElement) {
                    currentElement.classList.remove('visible-screen');
                    currentElement.classList.add('hidden-screen');
                    
                    previousElement.classList.remove('hidden-screen');
                    previousElement.classList.add('visible-screen');
                    
                    currentScreen = previousScreenId;
                    lucide.createIcons();
                }
            } else {
                // Fallback für Hauptmenü (z.B. wenn man von Einstellungen zurückgeht)
                transitionToScreen('main-menu-screen');
            }
        }
        
        function transitionToMainMenu() {
            transitionToScreen('main-menu-screen');
        }

        // --- Einstellungsfunktionen ---
        
        function selectGenre(genre) {
            selectedGenre = genre;
            const buttons = document.querySelectorAll('.genre-button');
            buttons.forEach(button => {
                if (button.textContent.trim() === genre) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            // Info anzeigen
            const infoText = document.querySelector('#genre-selection-screen p');
            switch (genre) {
                case 'Märchen':
                    infoText.textContent = 'Sanfte Erzählungen für Erwachsene und Kinder.';
                    break;
                case 'Hörbuch':
                    infoText.textContent = 'Lange, entspannende Geschichten mit unaufgeregtem Plot.';
                    break;
                case 'White Noise':
                    infoText.textContent = 'Neutrales, konstantes Rauschen zur Ablenkung von Umgebungsgeräuschen.';
                    break;
                case 'Naturgeräusche':
                    infoText.textContent = 'Beruhigende Klänge wie Regen, Wald oder Meeresrauschen.';
                    break;
                default:
                    infoText.textContent = '';
            }
        }
        
        function setTimerActive(button, minutes) {
            selectedTimerMinutes = parseInt(minutes);
            const buttons = document.querySelectorAll('#sleeptimer-selection-screen .timer-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Info anzeigen
            const infoText = document.querySelector('#sleeptimer-selection-screen p');
            if (minutes === '0') {
                infoText.textContent = 'Die Wiedergabe endet automatisch, wenn das Audio zu Ende ist.';
            } else {
                infoText.textContent = `Die Wiedergabe stoppt automatisch nach ${minutes} Minuten.`;
            }
        }

        function updateVoiceSetting() {
            selectedVoice = document.getElementById('voice-select').value;
            console.log("Ausgewählte Stimme:", selectedVoice);
        }

        // --- Atemübungsfunktionen ---

        let breathingInterval;
        let breathingTimeout;
        
        function startBreathingExercise() {
            transitionToScreen('breathing-screen');
            startBreathingAnimation();
        }

        function startBreathingAnimation() {
            const textElement = document.getElementById('breathing-text');
            const phases = [
                { text: 'Einatmen', duration: 4000 },
                { text: 'Ausatmen', duration: 4000 }
            ];
            let phaseIndex = 0;
            
            // Text sofort setzen
            textElement.textContent = phases[phaseIndex].text;

            // Timer-Funktion für den Textwechsel
            function updateText() {
                phaseIndex = (phaseIndex + 1) % phases.length;
                textElement.textContent = phases[phaseIndex].text;
            }
            
            // Starte den Intervall (wechselt alle 4 Sekunden)
            stopBreathingAnimation(); // Sicherstellen, dass keine alten Intervalle laufen
            breathingInterval = setInterval(updateText, 4000); 

            // Automatischer Skip nach 30 Sekunden (Platzhalter für die Dauer der Atemübung)
            breathingTimeout = setTimeout(() => {
                // Check if we are still on the breathing screen before auto-skipping
                if (currentScreen === 'breathing-screen') {
                    skipBreathing();
                }
            }, 30000); // 30 Sekunden
        }

        function stopBreathingAnimation() {
            clearInterval(breathingInterval);
            clearTimeout(breathingTimeout);
        }
        
        function skipBreathing() {
            stopBreathingAnimation();
            
            // Hier würde die Logik zum Generieren und Starten des Audioinhalts stehen
            document.getElementById('playback-title').textContent = `${selectedTimerMinutes === 0 ? 'Endlos' : selectedTimerMinutes + ' Min'} Routine`;
            document.getElementById('current-content-genre').textContent = selectedGenre;
            document.getElementById('current-content-title').textContent = `${selectedGenre} Geschichte`;
            
            transitionToScreen('playback-screen');
            // Hier sollte das Audio geladen werden...

            // Placeholder:
            showMessage(`Starte Routine mit Genre: ${selectedGenre}, Stimme: ${selectedVoice} und Timer: ${selectedTimerMinutes} Minuten.`);
            
            // Update profile stats (placeholder)
            routineCount++;
            totalTime += selectedTimerMinutes;
            lastGenre = selectedGenre;
            updateProfileDisplay();

            // Setzt Play-Status auf "playing" (Platzhalter)
            togglePlayback(true);
            
            // Setzt Timer-Anzeige
            if (selectedTimerMinutes > 0) {
                startCountdown(selectedTimerMinutes * 60);
            } else {
                document.getElementById('countdown-timer').textContent = '∞';
            }
        }

        // --- Playback-Funktionen ---

        function togglePlayback(play) {
            isPlaying = play;
            const playBtn = document.getElementById('play-button');
            const pauseBtn = document.getElementById('pause-button');

            if (play) {
                playBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                console.log("Playback gestartet.");
            } else {
                playBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                console.log("Playback pausiert.");
            }
        }

        function stopPlayback() {
            togglePlayback(false);
            stopCountdown();
            transitionToScreen('main-menu-screen'); // Zurück zum Hauptmenü
            showMessage("Wiedergabe gestoppt und beendet.");
        }
        
        // --- Timer-Funktionen ---
        
        let timerCountdownInterval;

        function startCountdown(durationInSeconds) {
            let timer = durationInSeconds;
            const display = document.getElementById('countdown-timer');

            function updateTimer() {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                const minsDisplay = minutes < 10 ? "0" + minutes : minutes;
                const secsDisplay = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minsDisplay + ":" + secsDisplay;

                if (--timer < 0) {
                    timer = 0; // Stoppt bei 0
                    stopPlayback();
                    showMessage("Der Sleeptimer ist abgelaufen. Gute Nacht!");
                }
            }
            
            stopCountdown(); // Vorherigen Timer stoppen
            updateTimer();
            timerCountdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            clearInterval(timerCountdownInterval);
        }


        // --- Profilfunktionen ---

        function showProfile() {
            updateProfileDisplay();
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('flex');
        }

        function hideProfile() {
            document.getElementById('profile-modal').classList.remove('flex');
            document.getElementById('profile-modal').classList.add('hidden');
        }

        function updateProfileDisplay() {
            document.getElementById('profile-routines').textContent = routineCount;
            document.getElementById('profile-time').textContent = totalTime;
            document.getElementById('profile-last-genre').textContent = lastGenre;
        }


        // --- Initialisierung ---

        document.addEventListener('DOMContentLoaded', () => {
            // Icons erstellen
            lucide.createIcons();
            
            // Setzt Standardwerte für die Anzeige, damit die Buttons korrekt aktiv sind
            selectGenre(selectedGenre);
            const defaultTimerButton = document.querySelector(`.timer-button[data-minutes="${selectedTimerMinutes}"]`);
            if (defaultTimerButton) {
                setTimerActive(defaultTimerButton, selectedTimerMinutes);
            }
        });
    </script>
</body>
</html>
